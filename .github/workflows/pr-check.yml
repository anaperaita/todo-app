name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Security: Define required permissions
permissions:
  contents: read
  pull-requests: write

jobs:
  pr-validation:
    name: PR Validation & Report
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm ci --frozen-lockfile

      - name: Build PR bundle
        run: npm run build
        env:
          CI: true

      - name: Get PR bundle size
        id: pr-size
        run: |
          PR_SIZE=$(du -sh build/ | cut -f1)
          PR_SIZE_BYTES=$(du -sb build/ | cut -f1)
          echo "size=$PR_SIZE" >> $GITHUB_OUTPUT
          echo "bytes=$PR_SIZE_BYTES" >> $GITHUB_OUTPUT

          # Get detailed JS sizes
          JS_SIZES=$(ls -lh build/static/js/*.js | awk '{printf "%-60s %10s\n", $9, $5}')
          echo "js_sizes<<EOF" >> $GITHUB_OUTPUT
          echo "$JS_SIZES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Build base bundle
        run: |
          npm ci --frozen-lockfile
          npm run build
        env:
          CI: true

      - name: Get base bundle size
        id: base-size
        run: |
          BASE_SIZE=$(du -sh build/ | cut -f1)
          BASE_SIZE_BYTES=$(du -sb build/ | cut -f1)
          echo "size=$BASE_SIZE" >> $GITHUB_OUTPUT
          echo "bytes=$BASE_SIZE_BYTES" >> $GITHUB_OUTPUT

      - name: Calculate size difference
        id: diff
        run: |
          PR_BYTES=${{ steps.pr-size.outputs.bytes }}
          BASE_BYTES=${{ steps.base-size.outputs.bytes }}
          DIFF_BYTES=$((PR_BYTES - BASE_BYTES))
          DIFF_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($DIFF_BYTES / $BASE_BYTES) * 100}")

          echo "bytes=$DIFF_BYTES" >> $GITHUB_OUTPUT
          echo "percent=$DIFF_PERCENT" >> $GITHUB_OUTPUT

          # Determine if change is significant
          if [ ${DIFF_BYTES#-} -gt 10240 ]; then
            echo "significant=true" >> $GITHUB_OUTPUT
          else
            echo "significant=false" >> $GITHUB_OUTPUT
          fi

          # Set emoji based on change
          if [ $DIFF_BYTES -gt 0 ]; then
            echo "emoji=üìà" >> $GITHUB_OUTPUT
            echo "status=increased" >> $GITHUB_OUTPUT
          elif [ $DIFF_BYTES -lt 0 ]; then
            echo "emoji=üìâ" >> $GITHUB_OUTPUT
            echo "status=decreased" >> $GITHUB_OUTPUT
          else
            echo "emoji=‚û°Ô∏è" >> $GITHUB_OUTPUT
            echo "status=unchanged" >> $GITHUB_OUTPUT
          fi

      - name: Run tests with coverage
        run: |
          git checkout ${{ github.event.pull_request.head.sha }}
          npm ci --frozen-lockfile
          npm test -- --watchAll=false --passWithNoTests --coverage --coverageReporters=json-summary
        env:
          CI: true

      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -p "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

            # Determine coverage emoji
            if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
              echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
              echo "emoji=‚ö†Ô∏è" >> $GITHUB_OUTPUT
            else
              echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            fi
          else
            echo "percentage=N/A" >> $GITHUB_OUTPUT
            echo "emoji=‚ÑπÔ∏è" >> $GITHUB_OUTPUT
          fi

      - name: Check PR title format
        id: pr-title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?:\ .+ ]]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "message=‚úÖ Follows conventional commit format" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "message=‚ö†Ô∏è Does not follow conventional commit format" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "Expected: \`type(scope): description\`" >> $GITHUB_OUTPUT
            echo "Types: feat, fix, docs, style, refactor, test, chore, perf" >> $GITHUB_OUTPUT
            echo "Example: \`feat(filters): add pill-style status buttons\`" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with detailed report
        uses: actions/github-script@v7
        with:
          script: |
            const prSize = '${{ steps.pr-size.outputs.size }}';
            const baseSize = '${{ steps.base-size.outputs.size }}';
            const diffBytes = parseInt('${{ steps.diff.outputs.bytes }}');
            const diffPercent = '${{ steps.diff.outputs.percent }}';
            const emoji = '${{ steps.diff.outputs.emoji }}';
            const status = '${{ steps.diff.outputs.status }}';
            const significant = '${{ steps.diff.outputs.significant }}' === 'true';
            const jsSizes = `${{ steps.pr-size.outputs.js_sizes }}`;
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const coverageEmoji = '${{ steps.coverage.outputs.emoji }}';
            const prTitleValid = '${{ steps.pr-title.outputs.valid }}' === 'true';
            const prTitleMessage = '${{ steps.pr-title.outputs.message }}';

            // Format size difference
            let diffStr;
            if (diffBytes > 0) {
              diffStr = `+${(diffBytes / 1024).toFixed(2)} KB (+${diffPercent}%)`;
            } else if (diffBytes < 0) {
              diffStr = `${(diffBytes / 1024).toFixed(2)} KB (${diffPercent}%)`;
            } else {
              diffStr = 'No change';
            }

            // Build warning section if significant increase
            let warningSection = '';
            if (significant && diffBytes > 0) {
              warningSection = `
            > ‚ö†Ô∏è **Warning:** Bundle size increased by more than 10 KB
            > Consider reviewing if this increase is necessary.
            `;
            }

            const comment = `## ü§ñ PR Build Report

            ### ${emoji} Bundle Size
            | Metric | Value |
            |--------|-------|
            | **PR Size** | ${prSize} |
            | **Base Size** | ${baseSize} |
            | **Difference** | ${diffStr} |
            | **Status** | ${status} |
            ${warningSection}

            ### üìä Test Coverage
            ${coverageEmoji} **${coverage}%** line coverage

            ### üìù PR Title Format
            ${prTitleMessage}

            ### üì¶ JavaScript Bundles (PR)
            \`\`\`
            ${jsSizes}
            \`\`\`

            ---
            <details>
            <summary>‚ÑπÔ∏è About this report</summary>

            This automated report compares your PR against the \`${context.payload.pull_request.base.ref}\` branch.

            - Bundle sizes are measured after gzip compression
            - Coverage is calculated from unit tests
            - PR title should follow [Conventional Commits](https://www.conventionalcommits.org/)
            </details>

            *Last updated: ${new Date().toUTCString()}*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ü§ñ PR Build Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if PR title is invalid
        if: steps.pr-title.outputs.valid == 'false'
        run: |
          echo "::error::PR title does not follow conventional commit format"
          echo "Expected format: type(scope): description"
          echo "Types: feat, fix, docs, style, refactor, test, chore, perf"
          echo "Example: feat(filters): add pill-style status buttons"
          exit 1
